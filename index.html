<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片裁剪工具</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- 设置按钮 -->
    <button id="settingsBtn" class="settings-btn" onclick="openSettings()" title="设置">⚙️</button>

    <!-- 设置面板 -->
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-content">
            <div class="settings-header">
                <h2>应用设置</h2>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>

            <div class="settings-body">
                <div class="setting-section">
                    <h3>当前页面</h3>
                    <select id="pageSelector" class="page-selector">
                        <option value="all">全局设置</option>
                        <option value="mode">模式选择页面</option>
                        <option value="single">单张模式页面</option>
                        <option value="batch">批量模式页面</option>
                        <option value="text">文本处理页面</option>
                    </select>
                </div>

                <div class="setting-section">
                    <h3>字体设置</h3>
                    <div class="font-settings">
                        <div class="setting-group">
                            <label>字体：</label>
                            <select id="fontSelector" class="font-selector">
                                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">默认字体</option>
                                <option value="'Microsoft YaHei', sans-serif">微软雅黑</option>
                                <option value="'SimHei', sans-serif">黑体</option>
                                <option value="'SimSun', serif">宋体</option>
                                <option value="'KaiTi', serif">楷体</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Courier New', monospace">Courier New</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label>文字颜色：</label>
                            <input type="color" id="textColorPicker" value="#333333">
                        </div>
                        <button class="btn-small" onclick="applyTextSettings()">应用文字设置</button>
                    </div>
                </div>

                <div class="setting-section">
                    <h3>预设背景</h3>
                    <div class="preset-backgrounds">
                        <button class="preset-bg" data-type="gradient1" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"></button>
                        <button class="preset-bg" data-type="gradient2" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"></button>
                        <button class="preset-bg" data-type="gradient3" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"></button>
                        <button class="preset-bg" data-type="gradient4" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)"></button>
                        <button class="preset-bg" data-type="gradient5" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%)"></button>
                        <button class="preset-bg" data-type="solid" style="background: #2c3e50"></button>
                    </div>
                </div>

                <div class="setting-section">
                    <h3>自定义颜色</h3>
                    <div class="color-picker-group">
                        <input type="color" id="bgColorPicker" value="#667eea">
                        <button class="btn-small" onclick="applyCustomColor()">应用颜色</button>
                    </div>
                </div>

                <div class="setting-section">
                    <h3>自定义图片背景</h3>
                    <input type="file" id="bgImageInput" accept="image/*" style="display: none;">
                    <button class="btn-small" onclick="document.getElementById('bgImageInput').click()">选择图片</button>
                    <button class="btn-small btn-delete" onclick="removeBgImage()">移除图片</button>
                    <div id="bgImagePreview" class="bg-image-preview"></div>
                </div>

                <div class="setting-section">
                    <h3>窗口透明度</h3>
                    <div class="opacity-control">
                        <label>操作窗口不透明度：<span id="opacityValue">95</span>%</label>
                        <input type="range" id="opacitySlider" min="70" max="100" value="95" step="5">
                    </div>
                </div>

                <div class="setting-section">
                    <h3>自定义模式图标</h3>
                    <div class="mode-icon-settings">
                        <div class="mode-icon-item">
                            <span>单张模式：</span>
                            <input type="file" id="singleIconInput" accept="image/*" style="display: none;">
                            <button class="btn-small" onclick="document.getElementById('singleIconInput').click()">选择图标</button>
                            <button class="btn-small btn-delete" onclick="resetModeIcon('single')">重置</button>
                        </div>
                        <div class="mode-icon-item">
                            <span>批量模式：</span>
                            <input type="file" id="batchIconInput" accept="image/*" style="display: none;">
                            <button class="btn-small" onclick="document.getElementById('batchIconInput').click()">选择图标</button>
                            <button class="btn-small btn-delete" onclick="resetModeIcon('batch')">重置</button>
                        </div>
                        <div class="mode-icon-item">
                            <span>文本模式：</span>
                            <input type="file" id="textIconInput" accept="image/*" style="display: none;">
                            <button class="btn-small" onclick="document.getElementById('textIconInput').click()">选择图标</button>
                            <button class="btn-small btn-delete" onclick="resetModeIcon('text')">重置</button>
                        </div>
                    </div>
                </div>

                <div class="setting-section">
                    <h3>设置同步</h3>
                    <button class="btn-small" onclick="generateShareLink()" style="width: 100%; margin-bottom: 10px;">生成分享链接</button>
                    <p style="font-size: 0.85em; color: #666; margin: 0;">生成包含所有设置的链接，在其他设备上打开即可应用相同配置</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 模式选择界面 -->
    <div id="modeSelection" class="mode-selection">
        <div class="mode-container">
            <h1>图片裁剪工具</h1>
            <p class="mode-subtitle">请选择工作模式</p>
            <div class="mode-cards">
                <div class="mode-card" onclick="selectMode('single')">
                    <div class="mode-icon" id="singleModeIcon">📷</div>
                    <div class="mode-text-box">
                        <h2>单张模式</h2>
                        <p>处理单张图片，精确调整裁剪位置</p>
                    </div>
                </div>
                <div class="mode-card" onclick="selectMode('batch')">
                    <div class="mode-icon" id="batchModeIcon">🖼️</div>
                    <div class="mode-text-box">
                        <h2>批量模式</h2>
                        <p>同时处理多张图片，提高工作效率</p>
                    </div>
                </div>
                <div class="mode-card" onclick="selectMode('text')">
                    <div class="mode-icon" id="textModeIcon">📝</div>
                    <div class="mode-text-box">
                        <h2>文本处理模式</h2>
                        <p>批量处理文本文件，添加内容到开头或结尾</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 单张模式界面 -->
    <div id="singleMode" class="container" style="display: none;">
        <div class="header-bar">
            <h1>图片裁剪工具 - 单张模式</h1>
            <div>
                <button class="btn-small" onclick="resetSingleMode()">清空数据</button>
                <button class="back-btn" onclick="backToModeSelection()">← 返回</button>
            </div>
        </div>

        <div class="upload-section">
            <input type="file" id="imageInput" accept="image/png, image/jpeg, image/jpg, image/webp">
            <label for="imageInput" class="upload-btn">选择图片</label>
        </div>

        <div class="settings-section">
            <div class="setting-group">
                <label>目标宽度：</label>
                <input type="number" id="targetWidth" value="1024" min="1">
            </div>
            <div class="setting-group">
                <label>目标高度：</label>
                <input type="number" id="targetHeight" value="1024" min="1">
            </div>
            <div class="setting-group">
                <label>缩放模式：</label>
                <select id="scaleMode">
                    <option value="short">基于短边缩放</option>
                    <option value="long">基于长边缩放</option>
                    <option value="width">基于宽度缩放</option>
                    <option value="height">基于高度缩放</option>
                </select>
            </div>
        </div>

        <div class="main-section">
            <div class="left-section">
                <div class="canvas-wrapper">
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="canvas"></canvas>
                        <div id="overlayTop" class="overlay-mask"></div>
                        <div id="overlayBottom" class="overlay-mask"></div>
                        <div id="overlayLeft" class="overlay-mask"></div>
                        <div id="overlayRight" class="overlay-mask"></div>
                        <div id="cropBox" class="crop-box">
                            <div class="crop-info-label" id="cropLabel"></div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <p id="originalSize">原始尺寸: -</p>
                    <p id="scaledSize">缩放后尺寸: -</p>
                    <p id="cropInfo">裁剪位置: -</p>
                </div>

                <div class="controls-section">
                    <button id="processBtn" class="btn" disabled>生成预览</button>
                </div>
            </div>

            <div class="right-section">
                <h3>裁剪预览</h3>
                <div class="preview-list" id="previewList">
                    <p class="empty-hint">暂无预览，请先处理图片</p>
                </div>
                <div class="download-section">
                    <button id="selectAllBtn" class="btn-small" disabled>全选</button>
                    <button id="downloadSelectedBtn" class="btn" disabled>下载选中项</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量模式 - 上传界面 -->
    <div id="batchUpload" class="container" style="display: none;">
        <div class="header-bar">
            <h1>批量模式 - 上传图片</h1>
            <div>
                <button class="btn-small" onclick="resetBatchMode()">清空数据</button>
                <button class="back-btn" onclick="backToModeSelection()">← 返回</button>
            </div>
        </div>

        <div class="batch-upload-area">
            <input type="file" id="batchImageInput" accept="image/png, image/jpeg, image/jpg, image/webp" multiple>
            <label for="batchImageInput" class="batch-upload-label">
                <div class="upload-icon">📁</div>
                <p>点击选择或拖拽图片到此处</p>
                <p class="upload-hint">支持 PNG、JPG、WEBP 格式，可一次选择多张</p>
            </label>
        </div>

        <div id="uploadedImages" class="uploaded-images" style="display: none;">
            <div class="uploaded-header">
                <h3>已上传图片 (<span id="uploadedCount">0</span>)</h3>
                <div class="uploaded-actions">
                    <button class="btn-small" onclick="selectAllUploaded()">全选</button>
                    <button class="btn-small" onclick="invertSelectionUploaded()">反选</button>
                    <button class="btn-small" onclick="deselectAllUploaded()">取消全选</button>
                    <button class="btn" onclick="proceedToEdit()">进入编辑 (<span id="selectedCount">0</span>)</button>
                </div>
            </div>
            <div id="uploadedGrid" class="uploaded-grid"></div>
        </div>
    </div>

    <!-- 批量模式 - 编辑界面 -->
    <div id="batchEdit" class="container batch-edit-container" style="display: none;">
        <div class="header-bar">
            <h1>批量模式 - 编辑裁剪</h1>
            <div>
                <button class="btn-small" onclick="resetBatchEdit()">清空数据</button>
                <button class="back-btn" onclick="backToBatchUpload()">← 返回上传</button>
            </div>
        </div>

        <div class="settings-section">
            <div class="setting-group">
                <label>目标宽度：</label>
                <input type="number" id="batchTargetWidth" value="1024" min="1">
            </div>
            <div class="setting-group">
                <label>目标高度：</label>
                <input type="number" id="batchTargetHeight" value="1024" min="1">
            </div>
            <div class="setting-group">
                <label>缩放模式：</label>
                <select id="batchScaleMode">
                    <option value="short">基于短边缩放</option>
                    <option value="long">基于长边缩放</option>
                    <option value="width">基于宽度缩放</option>
                    <option value="height">基于高度缩放</option>
                </select>
            </div>
            <div class="setting-group">
                <label>显示数量：</label>
                <select id="displayCount">
                    <option value="5">5张</option>
                    <option value="10">10张</option>
                    <option value="20">20张</option>
                </select>
            </div>
            <div class="setting-group">
                <label>布局模式：</label>
                <select id="layoutMode">
                    <option value="grid">网格布局</option>
                    <option value="vertical">垂直布局</option>
                </select>
            </div>
            <div class="setting-group">
                <label>统一裁剪：</label>
                <button class="btn-small" onclick="applyUniformCrop()">应用到全部</button>
            </div>
        </div>

        <div class="batch-main-section">
            <div class="batch-left-section">
                <div class="batch-toolbar">
                    <div class="batch-info">
                        <span>共 <strong id="totalImages">0</strong> 张</span>
                        <span>已选 <strong id="checkedImages">0</strong> 张</span>
                    </div>
                    <div class="batch-actions">
                        <button class="btn-small" onclick="batchSelectAll()">全选当前页</button>
                        <button class="btn-small" onclick="batchSelectAllPages()">全选所有页</button>
                        <button class="btn-small btn-delete" onclick="batchDeleteSelected()">删除选中</button>
                        <button class="btn" onclick="batchProcessSelected()">生成选中预览</button>
                    </div>
                </div>

                <div id="batchCanvasGrid" class="batch-canvas-grid"></div>

                <div id="batchPagination" class="batch-pagination">
                    <button onclick="prevPage()" id="prevPageBtn">← 上一页</button>
                    <span id="pageInfo">第 1 页 / 共 1 页</span>
                    <button onclick="nextPage()" id="nextPageBtn">下一页 →</button>
                    <div class="page-jumper">
                        <span>跳转至</span>
                        <input type="number" id="batchPageInput" min="1" value="1" class="page-input">
                        <button onclick="jumpToPage()" class="btn-small">跳转</button>
                    </div>
                    <div id="batchPageNumbers" class="page-numbers"></div>
                </div>
            </div>

            <div class="resizer" id="batchResizer"></div>

            <div class="right-section">
                <h3>裁剪预览</h3>
                <div class="preview-list" id="batchPreviewList">
                    <p class="empty-hint">暂无预览，请先处理图片</p>
                </div>
                <div class="download-section">
                    <button id="batchSelectAllPreviewBtn" class="btn-small" disabled>全选</button>
                    <button id="batchDeletePreviewBtn" class="btn-small btn-delete" disabled>删除选中</button>
                    <button id="batchDownloadSelectedBtn" class="btn" disabled>下载选中项</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文本处理模式 - 上传界面 -->
    <div id="textUpload" class="container" style="display: none;">
        <div class="header-bar">
            <h1>文本处理模式 - 上传文件</h1>
            <div>
                <button class="btn-small" onclick="resetTextMode()">清空数据</button>
                <button class="back-btn" onclick="backToModeSelection()">← 返回</button>
            </div>
        </div>

        <div class="batch-upload-area">
            <input type="file" id="textFileInput" accept=".txt,.md,.json,.csv,.log,.xml,.html,.css,.js,.py,.java,.c,.cpp,.h,.sh" multiple>
            <label for="textFileInput" class="batch-upload-label">
                <div class="upload-icon">📄</div>
                <p>点击选择或拖拽文本文件到此处</p>
                <p class="upload-hint">支持 TXT、MD、JSON、CSV 等文本格式，可一次选择多个</p>
            </label>
        </div>

        <div id="uploadedTexts" class="uploaded-images" style="display: none;">
            <div class="uploaded-header">
                <h3>已上传文件 (<span id="uploadedTextCount">0</span>)</h3>
                <div class="uploaded-actions">
                    <button class="btn-small" onclick="selectAllUploadedTexts()">全选</button>
                    <button class="btn-small" onclick="invertSelectionUploadedTexts()">反选</button>
                    <button class="btn-small" onclick="deselectAllUploadedTexts()">取消全选</button>
                    <button class="btn" onclick="proceedToTextEdit()">进入编辑 (<span id="selectedTextCount">0</span>)</button>
                </div>
            </div>
            <div id="uploadedTextGrid" class="uploaded-text-grid"></div>
        </div>
    </div>

    <!-- 文本处理模式 - 编辑界面 -->
    <div id="textEdit" class="container batch-edit-container" style="display: none;">
        <div class="header-bar">
            <h1>文本处理模式 - 编辑文本</h1>
            <div>
                <button class="btn-small" onclick="resetTextEdit()">清空数据</button>
                <button class="back-btn" onclick="backToTextUpload()">← 返回上传</button>
            </div>
        </div>

        <div class="settings-section">
            <div class="setting-group">
                <label>显示数量：</label>
                <select id="textDisplayCount">
                    <option value="5">5个</option>
                    <option value="10">10个</option>
                    <option value="20">20个</option>
                </select>
            </div>
        </div>

        <div class="text-input-section">
            <h3>要添加的文本内容</h3>
            <textarea id="textToAdd" placeholder="在此输入要添加到文件中的文本内容..."></textarea>
            <div class="text-add-controls">
                <div class="setting-group">
                    <label>添加位置：</label>
                    <select id="addPosition">
                        <option value="start">文件开头</option>
                        <option value="end">文件结尾</option>
                    </select>
                </div>
                <button class="btn" onclick="addTextToSelected()">添加到选中文件</button>
            </div>
        </div>

        <div class="batch-main-section">
            <div class="batch-left-section">
                <div class="batch-toolbar">
                    <div class="batch-info">
                        <span>共 <strong id="totalTexts">0</strong> 个</span>
                        <span>已选 <strong id="checkedTexts">0</strong> 个</span>
                    </div>
                    <div class="batch-actions">
                        <button class="btn-small" onclick="textSelectAll()">全选当前页</button>
                        <button class="btn-small" onclick="textSelectAllPages()">全选所有页</button>
                        <button class="btn-small btn-delete" onclick="textDeleteSelected()">删除选中</button>
                    </div>
                </div>

                <div id="textFileGrid" class="text-file-grid"></div>

                <div id="textPagination" class="batch-pagination">
                    <button onclick="prevTextPage()" id="prevTextPageBtn">← 上一页</button>
                    <span id="textPageInfo">第 1 页 / 共 1 页</span>
                    <button onclick="nextTextPage()" id="nextTextPageBtn">下一页 →</button>
                    <div class="page-jumper">
                        <span>跳转至</span>
                        <input type="number" id="textPageInput" min="1" value="1" class="page-input">
                        <button onclick="jumpToTextPage()" class="btn-small">跳转</button>
                    </div>
                    <div id="textPageNumbers" class="page-numbers"></div>
                </div>
            </div>

            <div class="resizer" id="textResizer"></div>

            <div class="right-section">
                <h3>处理预览 (共 <span id="totalPreviews">0</span> 个 | 已选 <span id="selectedPreviews">0</span> 个)</h3>
                <div class="preview-list" id="textPreviewList">
                    <p class="empty-hint">暂无预览，请先处理文件</p>
                </div>
                <div class="download-section">
                    <button id="textSelectAllPreviewBtn" class="btn-small" disabled>全选</button>
                    <button id="textDeletePreviewBtn" class="btn-small btn-delete" disabled>删除选中</button>
                    <button id="textDownloadSelectedBtn" class="btn" disabled>下载选中项</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 工具函数和常量 -->
    <script src="js/utils.js"></script>
    <!-- 设置功能 -->
    <script src="js/settings.js"></script>
    <!-- 单张模式 -->
    <script src="js/mode-single.js"></script>
    <!-- 批量模式 -->
    <script src="js/mode-batch.js"></script>
    <!-- 文本模式 -->
    <script src="js/mode-text.js"></script>
    <!-- 主逻辑 -->
    <script src="js/main.js"></script>
</body>
</html>
